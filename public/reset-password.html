<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - ReachInbox Onebox</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family:'Inter',sans-serif; background:#F9FAFB; min-height:100vh; display:flex; align-items:center; justify-content:center; }
        .card { background:#fff; width:100%; max-width:420px; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.08); padding:28px; }
        h1 { font-size:22px; margin:0 0 6px; color:#111827; }
        p { color:#6B7280; font-size:14px; margin:0 0 18px; }
        label { display:block; font-size:14px; color:#374151; margin:10px 0 6px; }
        input { width:100%; padding:12px 14px; border:1px solid #E5E7EB; border-radius:10px; font-size:14px; background:#F9FAFB; }
        input:focus { outline:none; border-color:#7C3AED; background:#fff; box-shadow:0 0 0 3px rgba(124,58,237,.12); }
        button { width:100%; padding:12px; border:none; background:#7C3AED; color:#fff; border-radius:10px; font-weight:600; margin-top:14px; cursor:pointer; }
        .alert { margin-top:12px; padding:10px 12px; border-radius:10px; font-size:13px; display:none; }
        .alert.success { background:#D1FAE5; color:#065F46; border:1px solid #A7F3D0; }
        .alert.error { background:#FEE2E2; color:#991B1B; border:1px solid #FECACA; }
        .link { display:inline-block; margin-top:14px; font-size:14px; color:#7C3AED; text-decoration:none; }
    </style>
</head>
<body>
    <div class="card">
        <h1>Reset your password</h1>
        <p id="subtitle">Validating reset link...</p>
        <div id="form" style="display:none">
            <label for="password">New password</label>
            <input id="password" type="password" placeholder="At least 8 characters" required />
            <label for="confirm">Confirm password</label>
            <input id="confirm" type="password" placeholder="Repeat password" required />
            <button id="saveBtn">Save new password</button>
        </div>
        <div id="msg" class="alert"></div>
        <a class="link" href="/login">Back to Sign In</a>
    </div>
    <script>
        const msg = document.getElementById('msg');
        const subtitle = document.getElementById('subtitle');
        const form = document.getElementById('form');
        const params = new URLSearchParams(window.location.search);
        const token = params.get('token');
        if (!token) { show('Invalid reset link', true); subtitle.textContent=''; }
        else {
            (async () => {
                try {
                    const res = await fetch('/api/password/reset/validate?token='+encodeURIComponent(token));
                    const data = await res.json();
                    if (!res.ok || !data.valid) throw new Error(data.message || 'Invalid token');
                    subtitle.textContent = 'Resetting password for '+data.email;
                    form.style.display = 'block';
                } catch (e) { show(e.message || 'Invalid or expired link', true); subtitle.textContent=''; }
            })();
        }
        document.getElementById('saveBtn').addEventListener('click', async () => {
            msg.style.display='none';
            const p = document.getElementById('password').value;
            const c = document.getElementById('confirm').value;
            if (!p || p.length<8) { show('Password must be at least 8 characters', true); return; }
            if (p !== c) { show('Passwords do not match', true); return; }
            try {
                const res = await fetch('/api/password/reset', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ token, newPassword: p }) });
                const data = await res.json();
                if (!res.ok || !data.success) throw new Error(data.message || 'Failed to reset');
                show('Password updated. You can sign in now.', false);
                setTimeout(()=>{ window.location.href='/login'; }, 1500);
            } catch (e) { show(e.message || 'Something went wrong', true); }
        });
        function show(text, isError){ msg.textContent=text; msg.className='alert ' + (isError?'error':'success'); msg.style.display='block'; }
    </script>
</body>
</html>
