<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReachInbox Onebox</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react-toastify/dist/react-toastify.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/react-toastify/dist/ReactToastify.css">
    <style>
        /* Enhanced Dashboard with Gradient Theme */
        body {
            background: linear-gradient(135deg, #7C3AED 0%, #8B5CF6 50%, #6D28D9 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            min-height: 100vh;
            position: relative;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            scroll-behavior: smooth;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes slideIn {
            0% {
                transform: translateX(-100%);
                opacity: 0;
            }
            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes modalSlideIn {
            0% {
                transform: translateY(-50px) scale(0.95);
                opacity: 0;
            }
            100% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        /* Main container with glassmorphism effect */
        .min-h-screen {
            position: relative;
            z-index: 1;
        }

        /* Header styling with gradient theme - Sticky Header */
        .bg-blue-600 {
            background: linear-gradient(135deg, #6D28D9 0%, #7C3AED 50%, #8B5CF6 100%) !important;
            box-shadow: 0 8px 32px rgba(109, 40, 217, 0.3);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky !important;
            top: 0 !important;
            z-index: 1000 !important;
            transition: all 0.3s ease-in-out;
        }

        /* Scroll-aware header effects */
        .header-scrolled {
            box-shadow: 0 4px 20px rgba(109, 40, 217, 0.4) !important;
            backdrop-filter: blur(15px) !important;
            background: linear-gradient(135deg, rgba(109, 40, 217, 0.95) 0%, rgba(124, 58, 237, 0.95) 50%, rgba(139, 92, 246, 0.95) 100%) !important;
        }

        /* Responsive header adjustments */
        @media (max-width: 768px) {
            .bg-blue-600 {
                padding: 0.75rem 0 !important;
            }
            
            .bg-blue-600 h1 {
                font-size: 1.25rem !important;
            }
            
            .bg-blue-600 p {
                font-size: 0.75rem !important;
            }
        }

        /* Ensure content doesn't get hidden behind sticky header */
        .main-content {
            position: relative;
            z-index: 1;
        }

        /* Notification positioning adjustments */
        .notification-container {
            margin-bottom: 80px; /* Space for theme toggle button */
        }

        @media (max-width: 768px) {
            .notification-container {
                margin-bottom: 60px;
                left: 1rem;
                right: 1rem;
                max-width: calc(100vw - 2rem);
            }
            
            /* Modal positioning for mobile */
            .fixed.inset-0.flex.items-start {
                padding-top: 1rem;
                padding-bottom: 1rem;
            }
            
            .fixed.inset-0.flex.items-start .bg-white {
                margin: 0.5rem;
                max-height: calc(100vh - 1rem);
                overflow-y: auto;
            }
        }

        /* Content containers with glassmorphism */
        .bg-white {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border-radius: 16px;
        }

        /* Enhanced email cards */
        .email-card {
            transition: all 0.3s ease-in-out;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border-radius: 12px;
        }
        
        .email-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            background: rgba(255, 255, 255, 0.95);
        }

         /* Enhanced buttons with gradient theme */
         .px-4.py-2.bg-blue-600 {
             background: linear-gradient(135deg, #7C3AED 0%, #8B5CF6 100%) !important;
             box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4);
             transition: all 0.3s ease;
             border: none;
         }

         /* Add Gmail button styling */
         .bg-white.bg-opacity-20 {
             background: rgba(255, 255, 255, 0.9) !important;
             color: #1f2937 !important;
             font-weight: 600;
             text-shadow: none;
             border: 1px solid rgba(255, 255, 255, 0.3);
         }

         .bg-white.bg-opacity-20:hover {
             background: rgba(255, 255, 255, 0.95) !important;
             color: #111827 !important;
             transform: translateY(-1px);
             box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
         }
        
        .px-4.py-2.bg-blue-600:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(124, 58, 237, 0.6);
        }

        .px-4.py-2.bg-green-600 {
            background: linear-gradient(135deg, #059669 0%, #10B981 100%) !important;
            box-shadow: 0 4px 15px rgba(5, 150, 105, 0.4);
        }

        .px-4.py-2.bg-green-600:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(5, 150, 105, 0.6);
        }

        .px-4.py-2.bg-purple-600 {
            background: linear-gradient(135deg, #7C3AED 0%, #8B5CF6 100%) !important;
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4);
        }

        .px-4.py-2.bg-purple-600:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(124, 58, 237, 0.6);
        }

        .px-4.py-2.bg-gray-600 {
            background: linear-gradient(135deg, #6B7280 0%, #9CA3AF 100%) !important;
            box-shadow: 0 4px 15px rgba(107, 114, 128, 0.4);
        }

        .px-4.py-2.bg-gray-600:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(107, 114, 128, 0.6);
        }

        .px-4.py-2.bg-orange-600 {
            background: linear-gradient(135deg, #EA580C 0%, #F97316 100%) !important;
            box-shadow: 0 4px 15px rgba(234, 88, 12, 0.4);
        }

        .px-4.py-2.bg-orange-600:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(234, 88, 12, 0.6);
        }

        /* Enhanced input fields */
        input, select, textarea {
            background: rgba(255, 255, 255, 0.9) !important;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
            transition: all 0.3s ease;
            border-radius: 8px;
        }

        input:focus, select:focus, textarea:focus {
            background: rgba(255, 255, 255, 0.95) !important;
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.3) !important;
            transform: translateY(-1px);
            border-color: #7C3AED !important;
        }

        /* Enhanced category badges */
        .category-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-weight: 500;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .category-interested { 
            background: linear-gradient(135deg, #dcfce7, #bbf7d0); 
            color: #166534; 
            box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);
        }
        .category-meeting-booked { 
            background: linear-gradient(135deg, #dbeafe, #bfdbfe); 
            color: #1e40af; 
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }
        .category-not-interested { 
            background: linear-gradient(135deg, #fef3c7, #fde68a); 
            color: #92400e; 
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
        }
        .category-spam { 
            background: linear-gradient(135deg, #fee2e2, #fecaca); 
            color: #991b1b; 
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }
        .category-out-of-office { 
            background: linear-gradient(135deg, #f3e8ff, #e9d5ff); 
            color: #7c3aed; 
            box-shadow: 0 2px 8px rgba(168, 85, 247, 0.3);
        }
        .category-uncategorized { 
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb); 
            color: #374151; 
            box-shadow: 0 2px 8px rgba(107, 114, 128, 0.3);
        }
        
        /* Enhanced priority styling */
        .priority-urgent { 
            background: linear-gradient(135deg, #fef2f2, #fecaca); 
            color: #dc2626; 
            border-left: 4px solid #dc2626; 
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.2);
        }
        .priority-high { 
            background: linear-gradient(135deg, #fef3c7, #fde68a); 
            color: #d97706; 
            border-left: 4px solid #d97706; 
            box-shadow: 0 4px 15px rgba(217, 119, 6, 0.2);
        }
        .priority-medium { 
            background: linear-gradient(135deg, #f0f9ff, #dbeafe); 
            color: #0284c7; 
            border-left: 4px solid #0284c7; 
            box-shadow: 0 4px 15px rgba(2, 132, 199, 0.2);
        }
        .priority-low { 
            background: linear-gradient(135deg, #f9fafb, #f3f4f6); 
            color: #6b7280; 
            border-left: 4px solid #6b7280; 
            box-shadow: 0 4px 15px rgba(107, 114, 128, 0.2);
        }
        
        /* Enhanced sentiment colors */
        .sentiment-positive { 
            color: #059669; 
            text-shadow: 0 1px 2px rgba(5, 150, 105, 0.3); 
        }
        .sentiment-negative { 
            color: #dc2626; 
            text-shadow: 0 1px 2px rgba(220, 38, 38, 0.3); 
        }
        .sentiment-neutral { 
            color: #6b7280; 
            text-shadow: 0 1px 2px rgba(107, 114, 128, 0.3); 
        }

        /* Enhanced modal styling */
        .fixed.inset-0.bg-black {
            background: rgba(0, 0, 0, 0.6) !important;
            backdrop-filter: blur(5px);
        }

        /* Enhanced notification styling */
        .bg-green-500, .bg-red-500, .bg-blue-500 {
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

         /* Light mode toggle button */
         .theme-toggle {
             position: fixed;
             bottom: 20px;
             left: 20px;
             z-index: 1000;
             background: rgba(255, 255, 255, 0.9);
             backdrop-filter: blur(10px);
             border: 1px solid rgba(255, 255, 255, 0.2);
             border-radius: 50px;
             padding: 8px 16px;
             cursor: pointer;
             transition: all 0.3s ease;
             box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
         }

        .theme-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        /* Light mode styles */
        body.light-mode {
            background: #F9FAFB;
            animation: none;
        }

        body.light-mode .bg-blue-600 {
            background: linear-gradient(135deg, #1E40AF 0%, #3B82F6 100%) !important;
        }

        body.light-mode .bg-white {
            background: white !important;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        body.light-mode .email-card {
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        /* Header stats styling for both themes */
        .header-stats-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 12px 16px;
            transition: all 0.3s ease;
        }

        .header-stats-container:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-1px);
        }

        /* Light mode header stats */
        body.light-mode .header-stats-container {
            background: rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        body.light-mode .header-stats-container:hover {
            background: rgba(0, 0, 0, 0.15);
        }

        /* Connection status styling */
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .connection-status:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Light mode connection status */
        body.light-mode .connection-status {
            background: rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        body.light-mode .connection-status:hover {
            background: rgba(0, 0, 0, 0.15);
        }

         /* Responsive adjustments */
         @media (max-width: 768px) {
             .theme-toggle {
                 bottom: 10px;
                 left: 10px;
                 padding: 6px 12px;
                 font-size: 12px;
             }
         }

        /* Smooth transitions for theme switching */
        * {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Simple authentication screen
        function AuthScreen({ onSignedIn }) {
            const [mode, setMode] = React.useState('signin');
            const [fullName, setFullName] = React.useState('');
            const [email, setEmail] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [confirmPassword, setConfirmPassword] = React.useState('');
            const [loading, setLoading] = React.useState(false);
            const [error, setError] = React.useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);
                try {
                    if (mode === 'signin') {
                        const res = await fetch('/api/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email, password, remember: true })
                        });
                        const data = await res.json();
                        if (!res.ok || !data.success) throw new Error(data.message || 'Sign in failed');
                        localStorage.setItem('authToken', data.token);
                        localStorage.setItem('authUser', JSON.stringify(data.user));
                        onSignedIn({ token: data.token, user: data.user });
                    } else {
                        const res = await fetch('/api/signup', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ fullName, email, password, confirmPassword })
                        });
                        const data = await res.json();
                        if (!res.ok || !data.success) throw new Error(data.message || 'Sign up failed');
                        // auto sign in
                        const loginRes = await fetch('/api/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email, password, remember: true })
                        });
                        const loginData = await loginRes.json();
                        if (!loginRes.ok || !loginData.success) throw new Error(loginData.message || 'Sign in failed');
                        localStorage.setItem('authToken', loginData.token);
                        localStorage.setItem('authUser', JSON.stringify(loginData.user));
                        onSignedIn({ token: loginData.token, user: loginData.user });
                    }
                } catch (err) {
                    setError(err.message || 'Something went wrong');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-gray-50 flex items-center justify-center px-4">
                    <div className="w-full max-w-md bg-white rounded-2xl shadow-xl p-8">
                        <div className="mb-6 text-center">
                            <div className="text-2xl font-bold text-gray-900">ReachInbox Onebox</div>
                            <div className="text-sm text-gray-500 mt-1">{mode === 'signin' ? 'Sign in to continue' : 'Create your account'}</div>
                        </div>
                        <div className="flex mb-6 bg-gray-100 rounded-lg p-1">
                            <button onClick={() => setMode('signin')} className={`flex-1 py-2 rounded-md text-sm font-medium ${mode==='signin' ? 'bg-white shadow text-gray-900' : 'text-gray-600'}`}>Sign In</button>
                            <button onClick={() => setMode('signup')} className={`flex-1 py-2 rounded-md text-sm font-medium ${mode==='signup' ? 'bg-white shadow text-gray-900' : 'text-gray-600'}`}>Sign Up</button>
                        </div>
                        {error && (<div className="mb-4 text-sm text-red-600">{error}</div>)}
                        <form onSubmit={handleSubmit} className="space-y-4">
                            {mode === 'signup' && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Full name</label>
                                    <input value={fullName} onChange={e=>setFullName(e.target.value)} className="mt-1 w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Jane Doe" required />
                                </div>
                            )}
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Email</label>
                                <input type="email" value={email} onChange={e=>setEmail(e.target.value)} className="mt-1 w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="you@example.com" required />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Password</label>
                                <input type="password" value={password} onChange={e=>setPassword(e.target.value)} className="mt-1 w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required />
                            </div>
                            {mode === 'signup' && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Confirm password</label>
                                    <input type="password" value={confirmPassword} onChange={e=>setConfirmPassword(e.target.value)} className="mt-1 w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required />
                                </div>
                            )}
                            <button type="submit" disabled={loading} className="w-full py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-md font-medium transition">{loading ? 'Please wait...' : (mode==='signin' ? 'Sign In' : 'Create account')}</button>
                        </form>
                    </div>
                </div>
            );
        }

        function App() {
            const [searchQuery, setSearchQuery] = useState('');
            const [emails, setEmails] = useState([]);
            const [accounts, setAccounts] = useState([]);
            const [selectedAccount, setSelectedAccount] = useState('');
            const [selectedCategory, setSelectedCategory] = useState('');
            const [selectedPriority, setSelectedPriority] = useState('');
            const [selectedSentiment, setSelectedSentiment] = useState('');
            const [dateFrom, setDateFrom] = useState('');
            const [dateTo, setDateTo] = useState('');
            const [loading, setLoading] = useState(false);
            const [stats, setStats] = useState(null);
            const [suggestedReply, setSuggestedReply] = useState('');
            const [replyLoading, setReplyLoading] = useState(false);
            const [showComposer, setShowComposer] = useState(false);
            const [showAnalytics, setShowAnalytics] = useState(false);
            const [notifications, setNotifications] = useState([]);

            // Sanitize and format email content for human-readable display
            const cleanEmailForDisplay = (raw) => {
                if (!raw) return '';
                let text = String(raw);

                // 1) Decode quoted-printable artifacts (e.g., =20, soft breaks, =E2=80=99)
                const qpDecode = (s) => {
                    // remove soft line breaks
                    s = s.replace(/=\r?\n/g, '');
                    // decode =HH hex bytes
                    return s.replace(/=([A-Fa-f0-9]{2})/g, (_, h) => {
                        try { return String.fromCharCode(parseInt(h, 16)); } catch { return _; }
                    });
                };
                if (/=\r?\n|=[A-Fa-f0-9]{2}/.test(text)) {
                    text = qpDecode(text);
                }

                // 2) Decode HTML entities (named + numeric)
                const named = { '&nbsp;': ' ', '&amp;': '&', '&lt;': '<', '&gt;': '>', '&quot;': '"', '&#39;': "'" };
                text = text.replace(/(&nbsp;|&amp;|&lt;|&gt;|&quot;|&#39;)/g, (m) => named[m] || '');
                text = text.replace(/&#(x?[0-9A-Fa-f]+);/g, (_, n) => {
                    try {
                        const code = /^x/i.test(n) ? parseInt(n.slice(1), 16) : parseInt(n, 10);
                        if (!isFinite(code)) return _;
                        return String.fromCharCode(code);
                    } catch { return _; }
                });

                // 3) Strip HTML tags to plain text context for preview usage
                text = text.replace(/<[^>]+>/g, ' ');

                // 3.1) Remove leading RFC822-style header block if present
                // Detect common header lines at the very start of the content and drop them until first blank line
                {
                    const headerLine = /^(from|to|subject|date|sent|cc|bcc|reply-to|content-type|content-transfer-encoding|mime-version|received|return-path|delivered-to|message-id|dkim-signature|authentication-results|x-[\w-]+):/i;
                    const lines = text.split(/\n/);
                    let i = 0;
                    while (i < lines.length && (headerLine.test(lines[i].trim()) || lines[i].trim() === '')) {
                        // Continue until we pass the initial header block and its separating blank line
                        if (lines[i].trim() === '' && i > 0) { i++; break; }
                        i++;
                    }
                    if (i > 0 && i < lines.length) {
                        text = lines.slice(i).join('\n');
                    }
                }

                // 4) Normalize unicode and remove zero-width/soft hyphen/control chars
                try { text = text.normalize('NFKC'); } catch {}
                text = text
                    .replace(/[\u200B-\u200D\uFEFF]/g, '') // zero width
                    .replace(/\u00AD/g, '') // soft hyphen
                    .replace(/[\u0000-\u0008\u000B\u000C\u000E-\u001F]/g, ''); // control except \t\n\r

                // 5) Remove tracking placeholders
                text = text.replace(/\[image:.*?\]|\(cid:.*?\)/gi, '');

                // 6) Remove common reply/forward headers and quoted lines (anywhere in body)
                text = text.split(/\n/)
                    .filter(line => !/^>/.test(line.trim()))
                    .filter(line => !/^(from|to|subject|date|sent|cc|bcc|reply-to|content-type|content-transfer-encoding|mime-version|received|return-path|delivered-to|message-id|dkim-signature|authentication-results|x-[\w-]+):/i.test(line.trim()))
                    .filter(line => !/^on .*wrote:$/i.test(line.trim()))
                    .join('\n');

                // 7) Tidy URLs inline preview (keep host/path only for very long URLs)
                text = text.replace(/https?:\/\/[\w.-]+(?:\/[\w\-./?=&%#]*)?/g, (u) => {
                    try { const { host, pathname } = new URL(u); return `${host}${pathname.length > 60 ? pathname.slice(0,60)+'â€¦' : pathname}`; } catch { return u; }
                });

                // 8) Collapse whitespace
                text = text.replace(/\u00A0/g, ' ');
                text = text.replace(/[\t ]{2,}/g, ' ');
                text = text.replace(/\n{3,}/g, '\n\n');
                return text.trim();
            };

            // Helpers for email detail header
            const getDisplayName = (from) => {
                const f = String(from || '').trim();
                const match = f.match(/^(.*?)\s*<([^>]+)>$/);
                if (match) return match[1] || match[2];
                return f;
            };

            const getInitials = (from) => {
                const name = getDisplayName(from);
                const parts = name.split(/\s+/).filter(Boolean);
                if (parts.length === 0) return 'U';
                if (parts.length === 1) return parts[0].slice(0,2).toUpperCase();
                return (parts[0][0] + parts[1][0]).toUpperCase();
            };

            // Render body preserving formatting when it's plain text
            const renderEmailBody = (raw) => {
                const text = cleanEmailForDisplay(raw);
                if (!text) return null;
                const hasHtml = /<[^>]+>/.test(String(raw || ''));
                if (hasHtml) {
                    return (
                        <div className="leading-7 text-[15px] text-gray-800" dangerouslySetInnerHTML={{ __html: linkifyEmailBody(raw) }} />
                    );
                }
                return (
                    <div className="leading-7 text-[15px] text-gray-800" dangerouslySetInnerHTML={{ __html: linkifyEmailBody(text) }} />
                );
            };
            const [wsConnected, setWsConnected] = useState(false);
            const [analytics, setAnalytics] = useState(null);
            const [searchSuggestions, setSearchSuggestions] = useState([]);
            const [showSuggestions, setShowSuggestions] = useState(false);
            const [showGmailSetup, setShowGmailSetup] = useState(false);
            const [gmailAccounts, setGmailAccounts] = useState([]);
            const [newGmailAccount, setNewGmailAccount] = useState({
                email: '',
                appPassword: '',
                name: ''
            });
             const [addingAccount, setAddingAccount] = useState(false);
            const [replyModalOpen, setReplyModalOpen] = useState(false);
            const [selectedEmail, setSelectedEmail] = useState(null);
            const [emailModalOpen, setEmailModalOpen] = useState(false);
            const [modalTop, setModalTop] = useState(100);
            const [replyData, setReplyData] = useState({
                to: '',
                subject: '',
                body: ''
            });
            const [sendingReply, setSendingReply] = useState(false);
            const [exportModalOpen, setExportModalOpen] = useState(false);
            const [pendingExportFormat, setPendingExportFormat] = useState('csv');
            const wsRef = useRef(null);

            // Auto-dismissing notification system
            const addNotification = (type, message) => {
                const notification = {
                    id: Date.now(),
                    type: type,
                    message: message,
                    timestamp: new Date().toISOString()
                };
                
                setNotifications(prev => [...prev, notification]);
                
                // Auto-dismiss after 5 seconds (7 seconds for success notifications)
                const dismissTime = type === 'success' ? 7000 : 5000;
                setTimeout(() => {
                    setNotifications(prev => prev.filter(n => n.id !== notification.id));
                }, dismissTime);
            };

            const [authToken, setAuthToken] = useState('');
            const [authUser, setAuthUser] = useState(null);

            // Load auth on mount
            useEffect(() => {
                const token = localStorage.getItem('authToken') || '';
                const user = localStorage.getItem('authUser');
                if (token) setAuthToken(token);
                if (user) { try { setAuthUser(JSON.parse(user)); } catch {} }
            }, []);

            const handleSignedIn = ({ token, user }) => {
                setAuthToken(token);
                setAuthUser(user || null);
                fetchAccounts();
                fetchStats();
            };

            const handleSignOut = () => {
                localStorage.removeItem('authToken');
                localStorage.removeItem('authUser');
                setAuthToken('');
                setAuthUser(null);
                setEmails([]);
                setAccounts([]);
                setStats(null);
            };

            // WebSocket connection for real-time updates
            useEffect(() => {
                const ws = new WebSocket('ws://localhost:8080');
                wsRef.current = ws;

                ws.onopen = () => {
                    setWsConnected(true);
                    console.log('WebSocket connected');
                };

                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    handleRealtimeUpdate(data);
                };

                ws.onclose = () => {
                    setWsConnected(false);
                    console.log('WebSocket disconnected');
                };

                return () => {
                    ws.close();
                };
            }, []);

            const handleRealtimeUpdate = (data) => {
                switch (data.type) {
                    case 'reply_generated':
                        addNotification('success', `Reply generated for email ${data.emailId}`);
                        break;
                    case 'email_composed':
                        addNotification('info', `New email composed to ${data.email.to}`);
                        break;
                    case 'integration_test':
                        addNotification('success', 'Integration test completed successfully');
                        break;
                    case 'stats_updated': {
                        // Live update total emails and related stats after add/remove/fetch
                        setStats(prev => ({
                            ...(prev || {}),
                            totalEmails: typeof data.totalEmails === 'number' ? data.totalEmails : (prev?.totalEmails || 0),
                            byAccount: data.byAccount || prev?.byAccount
                        }));
                        break;
                    }
                }
            };

            // Load accounts and stats on component mount
            useEffect(() => {
                if (authToken) {
                    fetchAccounts();
                    fetchStats();
                }
            }, [authToken]);

            // Sticky header scroll effect
            useEffect(() => {
                const handleScroll = () => {
                    const header = document.querySelector('header');
                    if (header) {
                        if (window.scrollY > 10) {
                            header.classList.add('header-scrolled');
                        } else {
                            header.classList.remove('header-scrolled');
                        }
                    }
                };

                window.addEventListener('scroll', handleScroll);
                return () => window.removeEventListener('scroll', handleScroll);
            }, []);

            const fetchAccounts = async () => {
                try {
                    // Fetch only real accounts from backend (no demo/mock)
                    const res = await fetch('/api/accounts');
                    const serverAccounts = await res.json();
                    // Normalize to include a type for downstream checks
                    const normalized = (serverAccounts || []).map(acc => ({ ...acc, type: 'gmail' }));
                    setAccounts(normalized);
                    // Ensure selection only when an account exists
                    setSelectedAccount(normalized.length > 0 ? normalized[0].id : '');
                    // If no accounts, clear any prior results/stats
                    if (normalized.length === 0) {
                        setEmails([]);
                        setAnalytics(null);
                        setStats(null);
                    }
                } catch (error) {
                    console.error('Error fetching accounts:', error);
                }
            };

            // Deprecated: separate Gmail accounts list is not needed; server returns only real accounts

            const fetchStats = async () => {
                try {
                    const response = await fetch('/api/stats');
                    const statsData = await response.json();
                    setStats(statsData);
                } catch (error) {
                    console.error('Error fetching stats:', error);
                }
            };

            const searchEmails = async () => {
                setLoading(true);
                try {
                    const selectedAccountData = accounts.find(acc => acc.id === selectedAccount);
                    // Block searching when no real account is selected
                    if (!selectedAccountData) {
                        setEmails([]);
                        setAnalytics(null);
                        addNotification('info', 'Add a Gmail account first, then select it to search.');
                        return;
                    }
                    // Always fetch from Gmail for selected real account
                    await fetchGmailEmails(selectedAccountData);
                } catch (error) {
                    console.error('Error searching emails:', error);
                    addNotification('error', 'Error searching emails');
                } finally {
                    setLoading(false);
                }
            };

            const fetchGmailEmails = async (gmailAccount) => {
                try {
                    const params = new URLSearchParams({
                        q: searchQuery || '',
                        account: gmailAccount.id || '',
                        category: selectedCategory || '',
                        priority: selectedPriority || '',
                        sentiment: selectedSentiment || '',
                        dateFrom: dateFrom || '',
                        dateTo: dateTo || '',
                        page: '0',
                        size: '200'
                    });
                    console.log(`ðŸ” Fetching emails for account: ${gmailAccount.email} (ID: ${gmailAccount.id})`);
                    const response = await fetch(`/api/emails/search?${params}`);
                    const data = await response.json();
                    const hits = Array.isArray(data.hits) ? data.hits : [];

                    // Prioritize locally: urgent > high > medium > low
                    const priorityOrder = { urgent: 0, high: 1, medium: 2, low: 3 };
                    hits.sort((a, b) => {
                        const pa = (a._source?.priority || a.priority || 'low').toLowerCase();
                        const pb = (b._source?.priority || b.priority || 'low').toLowerCase();
                        return (priorityOrder[pa] ?? 3) - (priorityOrder[pb] ?? 3);
                    });

                    setEmails(hits);
                    setAnalytics(data.analytics || {});
                    
                    // Refresh stats to update email count
                    await fetchStats();

                    if (hits.length > 0) {
                        addNotification('success', `Found ${hits.length} emails${gmailAccount?.email ? ` for ${gmailAccount.email}` : ''}`);
                    } else {
                        addNotification('info', 'No emails found');
                    }
                } catch (error) {
                    console.error('Error fetching Gmail emails:', error);
                    addNotification('error', 'Failed to fetch Gmail emails');
                }
            };

            // Auto-search when account is selected or filters change (with debounce)
            useEffect(() => {
                const timeoutId = setTimeout(() => {
                    const selectedAccountData = accounts.find(acc => acc.id === selectedAccount);
                    console.log(`ðŸ”„ Account changed to: ${selectedAccount}`, selectedAccountData);
                    if (selectedAccountData) {
                        console.log(`ðŸ“§ Triggering search for account: ${selectedAccountData.email}`);
                        searchEmails();
                    }
                }, 500); // 500ms debounce

                return () => clearTimeout(timeoutId);
            }, [accounts, selectedAccount, selectedCategory, selectedPriority, selectedSentiment, dateFrom, dateTo]);

            // Search suggestions
            const getSearchSuggestions = (query) => {
                const suggestions = [
                    'urgent', 'meeting', 'interested', 'spam', 'out of office',
                    'high priority', 'positive sentiment', 'negative sentiment',
                    'demo', 'pricing', 'support', 'sales', 'marketing'
                ];
                return suggestions.filter(suggestion => 
                    suggestion.toLowerCase().includes(query.toLowerCase())
                ).slice(0, 5);
            };

            const handleSearchInputChange = (e) => {
                const value = e.target.value;
                setSearchQuery(value);
                
                if (value.length > 1) {
                    const suggestions = getSearchSuggestions(value);
                    setSearchSuggestions(suggestions);
                    setShowSuggestions(suggestions.length > 0);
                } else {
                    setShowSuggestions(false);
                }
            };

            // Gmail account management functions
            const addGmailAccount = async () => {
                 // Basic validation
                 if (!newGmailAccount.name.trim()) {
                     addNotification('error', 'Please enter an account name');
                     return;
                 }
                 
                 if (!newGmailAccount.email.trim()) {
                     addNotification('error', 'Please enter your Gmail address');
                     return;
                 }
                 
                 if (!newGmailAccount.appPassword.trim()) {
                     addNotification('error', 'Please enter your app password');
                     return;
                 }
                 
                 setAddingAccount(true);
                 
                 // Show loading notification
                 addNotification('info', 'Validating Gmail credentials... This may take a few seconds.');
                 
                try {
                    const response = await fetch('/api/gmail-accounts', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(newGmailAccount)
                    });
                    
                        const result = await response.json();
                     
                     // Debug logging
                     console.log('ðŸ” Response status:', response.status);
                     console.log('ðŸ” Response ok:', response.ok);
                     console.log('ðŸ” Result:', result);
                     console.log('ðŸ” Result success:', result.success);
                     
                     if (response.ok && result.success) {
                         // Only add to local state if validation was successful
                        setGmailAccounts(prev => [...prev, result.account]);
                        setNewGmailAccount({ email: '', appPassword: '', name: '' });
                        setShowGmailSetup(false);
                         addNotification('success', `âœ… Gmail account ${newGmailAccount.email} added successfully! Credentials validated.`);
                        
                        // Refresh accounts list to include the new Gmail account
                        await fetchAccounts();

                        // Select the newly added account in the dropdown
                        setSelectedAccount(result.account.id);
                        console.log(`âœ… Selected newly added account: ${result.account.email} (${result.account.id})`);

                        // Trigger server-side fetch for this account to ensure emails are ingested
                        try {
                            const fetchRes = await fetch(`/api/gmail-accounts/${result.account.id}/fetch-emails`, { method: 'POST' });
                            const fetchJson = await fetchRes.json().catch(() => ({}));
                            console.log('ðŸ” Server fetch response:', fetchRes.status, fetchJson);
                        } catch (e) {
                            console.warn('âš ï¸ Could not trigger server fetch for new account:', e);
                        }

                        // Finally refresh the UI by searching for emails of the newly selected account
                        setTimeout(() => {
                            console.log('ðŸ”Ž Refreshing search for newly added account...');
                            searchEmails();
                        }, 500);
                         
                    } else {
                         // Validation failed - don't add to accounts, don't refresh
                         console.log('âŒ Gmail validation failed:', result.error);
                         addNotification('error', result.error || 'Failed to add Gmail account');
                         // Don't call fetchAccounts() here - it would add invalid accounts
                    }
                } catch (error) {
                    console.error('Error adding Gmail account:', error);
                     addNotification('error', 'Network error. Please check your connection and try again.');
                 } finally {
                     setAddingAccount(false);
                }
            };

            const removeGmailAccount = async (accountId) => {
                try {
                    const response = await fetch(`/api/gmail-accounts/${accountId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        const result = await response.json().catch(() => ({}));
                        setGmailAccounts(prev => prev.filter(acc => acc.id !== accountId));
                        addNotification('success', result?.message || 'Gmail account removed successfully!');

                        // If the removed account is currently selected, switch selection
                        if (selectedAccount === accountId) {
                            const remaining = accounts.filter(acc => acc.id !== accountId);
                            setSelectedAccount(remaining.length > 0 ? remaining[0].id : '');
                        }

                        // Clear the current emails view since store has changed
                        setEmails(prev => prev.filter(e => (e._source?.accountId || e.accountId) !== accountId));

                        // Refresh stats from server for updated totals
                        await fetchStats();

                        // Refresh accounts list to remove the Gmail account
                        fetchAccounts();
                    } else {
                        addNotification('error', 'Failed to remove Gmail account');
                    }
                } catch (error) {
                    console.error('Error removing Gmail account:', error);
                    addNotification('error', 'Failed to remove Gmail account');
                }
            };

            const testGmailConnection = async (accountId) => {
                try {
                    const response = await fetch(`/api/gmail-accounts/${accountId}/test`, {
                        method: 'POST'
                    });
                    
                    if (response.ok) {
                        addNotification('success', 'Gmail connection test successful!');
                    } else {
                        addNotification('error', 'Gmail connection test failed');
                    }
                } catch (error) {
                    console.error('Error testing Gmail connection:', error);
                    addNotification('error', 'Failed to test Gmail connection');
                }
            };

            const generateReply = async (emailId) => {
                setReplyLoading(true);
                setSuggestedReply('');
                try {
                    const response = await fetch(`/api/emails/${emailId}/suggest-reply`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    const data = await response.json();
                    setSuggestedReply(data.suggestion);
                } catch (error) {
                    console.error('Error generating reply:', error);
                    addNotification('error', 'Error generating reply');
                } finally {
                    setReplyLoading(false);
                }
            };

            // Reply modal functions
            const openReplyModal = (email) => {
                setSelectedEmail(email);
                setReplyData({
                    to: email._source?.from || email.from || '',
                    subject: `Re: ${email._source?.subject || email.subject || ''}`,
                    body: ''
                });
                setReplyModalOpen(true);
            };

            // Email content modal controls
            const openEmailModal = (email, evt) => {
                setSelectedEmail(email);
                try {
                    const clickY = (evt && typeof evt.clientY === 'number') ? evt.clientY : 100;
                    const scrollY = (typeof window !== 'undefined' ? window.scrollY : 0);
                    const pageY = scrollY + clickY; // anchor at click position
                    const minTop = scrollY + 80;
                    const maxTop = scrollY + (typeof window !== 'undefined' ? window.innerHeight : 600) - 80;
                    const clamped = Math.max(minTop, Math.min(pageY, maxTop));
                    setModalTop(clamped);
                } catch (_) { setModalTop(100); }
                setEmailModalOpen(true);
            };

            const closeEmailModal = () => {
                setEmailModalOpen(false);
                setSelectedEmail(null);
            };

            const closeReplyModal = () => {
                setReplyModalOpen(false);
                setSelectedEmail(null);
                setReplyData({ to: '', subject: '', body: '' });
            };

            const handleSendReply = async () => {
                if (!selectedEmail || !replyData.body.trim()) {
                    addNotification('error', 'Please enter a reply message');
                    return;
                }

                setSendingReply(true);
                try {
                    const response = await fetch(`/api/emails/${selectedEmail._id || selectedEmail.id}/reply`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            replyText: replyData.body,
                            to: replyData.to,
                            subject: replyData.subject
                        })
                    });

                    const data = await response.json();
                    if (data.success) {
                        addNotification('success', `âœ… Reply sent successfully to ${replyData.to}!`);
                        closeReplyModal();
                    } else {
                        addNotification('error', data.error || 'Failed to send reply');
                    }
                } catch (error) {
                    console.error('Error sending reply:', error);
                    addNotification('error', 'Failed to send reply');
                } finally {
                    setSendingReply(false);
                }
            };

            const testIntegrations = async () => {
                try {
                    const response = await fetch('/api/test-integrations', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    const data = await response.json();
                    addNotification('success', 'Integration test completed');
                } catch (error) {
                    console.error('Error testing integrations:', error);
                    addNotification('error', 'Integration test failed');
                }
            };

            // Convert plain-text URLs to clickable anchors and preserve line breaks
            const linkifyEmailBody = (raw) => {
                const text = cleanEmailForDisplay(raw);
                if (!text) return '';
                const urlRegex = /(https?:\/\/[\w.-]+(?:\/[\w\-./?=&%#]*)?)/g;
                const withLinks = text.replace(urlRegex, (u) => `<a href="${u}" target="_blank" rel="noopener noreferrer" class="text-blue-600 underline">${u}</a>`);
                return withLinks.replace(/\n/g, '<br/>');
            };

            // Extract likely media links for preview (images/pdf)
            const extractMediaLinks = (raw) => {
                const text = String(raw || '');
                const urlRegex = /(https?:\/\/[\w.-]+(?:\/[\w\-./?=&%#]*)?)/g;
                const urls = (text.match(urlRegex) || []).slice(0, 10);
                const images = urls.filter(u => /\.(png|jpe?g|gif|webp)$/i.test(u));
                const pdfs = urls.filter(u => /\.(pdf)(\?|$)/i.test(u));
                return { images, pdfs };
            };

            const showExportConfirmation = (format = 'csv') => {
                setPendingExportFormat(format);
                setExportModalOpen(true);
            };

            const exportEmails = async (format = 'csv', exportAll = false) => {
                try {
                    if (exportAll) {
                        // Export all emails from all accounts
                        const params = new URLSearchParams({
                            format: format,
                            q: '',
                            account: '',
                            category: '',
                            priority: '',
                            sentiment: '',
                            dateFrom: '',
                            dateTo: ''
                        });
                        
                        const response = await fetch(`/api/emails/export?${params}`);
                        
                        if (format === 'csv') {
                            if (response.ok) {
                                const blob = await response.blob();
                                const url = window.URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.href = url;
                                a.download = 'all_emails.csv';
                                document.body.appendChild(a);
                                a.click();
                                document.body.removeChild(a);
                                window.URL.revokeObjectURL(url);
                                
                                addNotification('success', `All emails exported as ${format.toUpperCase()} successfully!`);
                            } else {
                                const errorData = await response.json();
                                addNotification('error', `Export failed: ${errorData.message || 'Unknown error'}`);
                            }
                        }
                    } else {
                        // Export only the currently visible/filtered emails
                        // Try server-side export first (more reliable)
                        try {
                            // Ensure we have a selected account
                            if (!selectedAccount) {
                                addNotification('error', 'Please select an account first before exporting.');
                                return;
                            }
                            
                    const params = new URLSearchParams({
                        format: format,
                        q: searchQuery || '',
                                account: selectedAccount, // Force account filter
                        category: selectedCategory || '',
                        priority: selectedPriority || '',
                        sentiment: selectedSentiment || '',
                        dateFrom: dateFrom || '',
                        dateTo: dateTo || ''
                    });
                            
                            console.log('ðŸ” Using server-side export with params:', params.toString());
                            console.log('ðŸ” Current selectedAccount:', selectedAccount);
                            console.log('ðŸ” Account filter will be applied:', selectedAccount);
                    
                    const response = await fetch(`/api/emails/export?${params}`);
                            
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                    
                    if (format === 'csv') {
                            const blob = await response.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                                a.download = `account_${selectedAccount}_emails.csv`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            window.URL.revokeObjectURL(url);
                            
                                addNotification('success', `Emails from selected account exported as ${format.toUpperCase()} successfully!`);
                            }
                            
                        } catch (error) {
                            console.error('âŒ Server-side export failed, trying client-side:', error);
                            
                            // Fallback to client-side export
                            try {
                                // Ensure we have a selected account for fallback too
                                if (!selectedAccount) {
                                    addNotification('error', 'Please select an account first before exporting.');
                                    return;
                                }
                                
                                const params = new URLSearchParams({
                                    q: searchQuery || '',
                                    account: selectedAccount, // Force account filter
                                    category: selectedCategory || '',
                                    priority: selectedPriority || '',
                                    sentiment: selectedSentiment || '',
                                    dateFrom: dateFrom || '',
                                    dateTo: dateTo || '',
                                    page: '0',
                                    size: '1000'
                                });
                                
                                console.log('ðŸ” Fallback: Fetching emails for client-side export with account:', selectedAccount);
                                
                                const response = await fetch(`/api/emails/search?${params}`);
                                
                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }
                                
                        const data = await response.json();
                                const visibleEmails = data.hits || [];
                                
                                console.log('ðŸ“Š Found emails for export:', visibleEmails.length);
                                console.log('ðŸ“Š Account filter applied:', selectedAccount);
                                
                                if (visibleEmails.length === 0) {
                                    addNotification('error', 'No emails found for the selected account. Please check if the account has emails or try refreshing.');
                                    return;
                                }
                                
                                const csvContent = createCSVFromEmails(visibleEmails);
                                
                                if (!csvContent || csvContent.length === 0) {
                                    addNotification('error', 'Failed to generate CSV content. Please try again.');
                                    return;
                                }
                                
                                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                                const url = window.URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.href = url;
                                a.download = `account_${selectedAccount}_emails.csv`;
                                document.body.appendChild(a);
                                a.click();
                                document.body.removeChild(a);
                                window.URL.revokeObjectURL(url);
                                
                                addNotification('success', `${visibleEmails.length} emails from selected account exported as ${format.toUpperCase()} successfully!`);
                                
                            } catch (fallbackError) {
                                console.error('âŒ Client-side export also failed:', fallbackError);
                                addNotification('error', `Export failed: ${fallbackError.message}`);
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error exporting emails:', error);
                    addNotification('error', 'Failed to export emails. Please try again.');
                }
            };

            const createCSVFromEmails = (emailList) => {
                if (!emailList || emailList.length === 0) return '';
                
                console.log('ðŸ“ Creating CSV from emails:', emailList.length);
                
                // CSV headers
                const headers = [
                    'ID',
                    'From',
                    'To',
                    'Subject',
                    'Date',
                    'Category',
                    'Priority',
                    'Sentiment',
                    'Lead Score',
                    'Snippet'
                ];
                
                // Create CSV rows
                const rows = emailList.map((email, index) => {
                    const emailData = email._source || email;
                    
                    // Debug log for first few emails
                    if (index < 3) {
                        console.log(`ðŸ“§ Email ${index + 1} data:`, {
                            id: emailData.id,
                            from: emailData.from,
                            subject: emailData.subject,
                            category: emailData.aiCategory || emailData.category
                        });
                    }
                    
                    return [
                        `"${(emailData.id || '').replace(/"/g, '""')}"`,
                        `"${(emailData.from || '').replace(/"/g, '""')}"`,
                        `"${(Array.isArray(emailData.to) ? emailData.to.join(', ') : emailData.to || '').replace(/"/g, '""')}"`,
                        `"${(emailData.subject || '').replace(/"/g, '""')}"`,
                        `"${(emailData.readableDate || emailData.date || '').replace(/"/g, '""')}"`,
                        `"${(emailData.aiCategory || emailData.category || '').replace(/"/g, '""')}"`,
                        `"${(emailData.priority || '').replace(/"/g, '""')}"`,
                        `"${(emailData.sentiment || '').replace(/"/g, '""')}"`,
                        `"${(emailData.leadScore || '').replace(/"/g, '""')}"`,
                        `"${(emailData.snippet || emailData.body?.substring(0, 100) || '').replace(/"/g, '""')}"`
                    ].join(',');
                });
                
                const csvContent = [headers.join(','), ...rows].join('\n');
                console.log('ðŸ“„ CSV content length:', csvContent.length);
                
                return csvContent;
            };

            const handleExportConfirm = (exportAll) => {
                setExportModalOpen(false);
                exportEmails(pendingExportFormat, exportAll);
            };

            const getCategoryClass = (category) => {
                const categoryMap = {
                    'Interested': 'category-interested',
                    'Meeting Booked': 'category-meeting-booked',
                    'Not Interested': 'category-not-interested',
                    'Spam': 'category-spam',
                    'Out of Office': 'category-out-of-office'
                };
                return categoryMap[category] || 'category-uncategorized';
            };

            const getPriorityClass = (priority) => {
                const priorityMap = {
                    'urgent': 'priority-urgent',
                    'high': 'priority-high',
                    'medium': 'priority-medium',
                    'low': 'priority-low'
                };
                return priorityMap[priority] || 'priority-low';
            };

            const getSentimentClass = (sentiment) => {
                const sentimentMap = {
                    'positive': 'sentiment-positive',
                    'negative': 'sentiment-negative',
                    'neutral': 'sentiment-neutral'
                };
                return sentimentMap[sentiment] || 'sentiment-neutral';
            };

            const formatDate = (dateString) => {
                try {
                    if (!dateString) return 'No date';
                    const date = new Date(dateString);
                    if (isNaN(date.getTime())) return 'Invalid date';
                    return date.toLocaleString();
                } catch (error) {
                    return 'Invalid date';
                }
            };

            const EmailComposer = () => {
                const [composeData, setComposeData] = useState({
                    to: '',
                    subject: '',
                    body: ''
                });

                const handleCompose = async () => {
                    try {
                        const response = await fetch('/api/emails/compose', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(composeData)
                        });
                        const data = await response.json();
                        
                        addNotification('success', 'Email composed successfully');
                        
                        setShowComposer(false);
                        setComposeData({ to: '', subject: '', body: '' });
                    } catch (error) {
                        console.error('Error composing email:', error);
                    }
                };

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div className="bg-white rounded-lg p-6 max-w-2xl w-full mx-4">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="text-lg font-semibold">Compose Email</h3>
                                <button
                                    onClick={() => setShowComposer(false)}
                                    className="text-gray-400 hover:text-gray-600"
                                >
                                    âœ•
                                </button>
                            </div>
                            <div className="space-y-4">
                                <input
                                    type="email"
                                    placeholder="To"
                                    value={composeData.to}
                                    onChange={(e) => setComposeData({...composeData, to: e.target.value})}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md"
                                />
                                <input
                                    type="text"
                                    placeholder="Subject"
                                    value={composeData.subject}
                                    onChange={(e) => setComposeData({...composeData, subject: e.target.value})}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md"
                                />
                                <textarea
                                    placeholder="Message"
                                    value={composeData.body}
                                    onChange={(e) => setComposeData({...composeData, body: e.target.value})}
                                    rows={6}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-md"
                                />
                            </div>
                            <div className="flex justify-end space-x-2 mt-4">
                                <button
                                    onClick={() => setShowComposer(false)}
                                    className="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50"
                                >
                                    Cancel
                                </button>
                                <button
                                    onClick={handleCompose}
                                    className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
                                >
                                    Send Email
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            const AnalyticsDashboard = () => {
                if (!analytics) return null;

                // Pre-compute totals for visuals
                const totalByCategory = (analytics.byCategory || []).reduce((s, c) => s + (c.doc_count || 0), 0) || 1;
                const totalByPriority = (analytics.byPriority || []).reduce((s, c) => s + (c.doc_count || 0), 0) || 1;
                const totalBySentiment = (analytics.bySentiment || []).reduce((s, c) => s + (c.doc_count || 0), 0) || 1;

                // Build conic-gradient for donut chart (categories)
                let currentStop = 0;
                const categoryColors = ['#7C3AED','#8B5CF6','#06B6D4','#F59E0B','#10B981','#EF4444'];
                const donutStops = (analytics.byCategory || []).map((c, idx) => {
                    const pct = Math.round((c.doc_count / totalByCategory) * 100);
                    const start = currentStop;
                    const end = currentStop + pct;
                    currentStop = end;
                    return `${categoryColors[idx % categoryColors.length]} ${start}% ${end}%`;
                }).join(', ');

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 pt-24 pb-8">
                        <div className="bg-white rounded-2xl p-6 max-w-6xl w-full mx-4 max-h-[85vh] overflow-y-auto shadow-2xl">
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="text-2xl font-semibold bg-clip-text text-transparent bg-gradient-to-r from-purple-600 to-indigo-500">Analytics Dashboard</h3>
                                <div className="flex items-center gap-3">
                                <button
                                    onClick={() => setShowAnalytics(false)}
                                    className="text-gray-400 hover:text-gray-600"
                                >
                                    âœ•
                                </button>
                                </div>
                            </div>
                            
                            {/* Stat cards */}
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                                <div className="rounded-xl p-4 bg-gradient-to-br from-purple-50 to-white border border-purple-100">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <div className="text-xs uppercase tracking-wide text-purple-600">Total Emails</div>
                                            <div className="text-3xl font-extrabold text-purple-800">{analytics.totalEmails}</div>
                                </div>
                                        <div className="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center">
                                            <span>ðŸ“¬</span>
                                </div>
                                </div>
                                </div>
                                <div className="rounded-xl p-4 bg-gradient-to-br from-indigo-50 to-white border border-indigo-100">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <div className="text-xs uppercase tracking-wide text-indigo-600">Avg Lead Score</div>
                                            <div className="text-3xl font-extrabold text-indigo-800">{analytics.avgLeadScore}</div>
                            </div>
                                        <div className="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center">
                                            <span>ðŸ“ˆ</span>
                                        </div>
                                    </div>
                                </div>
                                <div className="rounded-xl p-4 bg-gradient-to-br from-pink-50 to-white border border-pink-100">
                                    <div className="flex items-center justify-between">
                                <div>
                                            <div className="text-xs uppercase tracking-wide text-pink-600">Urgent</div>
                                            <div className="text-3xl font-extrabold text-pink-800">{analytics.urgentEmails || 0}</div>
                                            </div>
                                        <div className="w-10 h-10 rounded-full bg-pink-100 flex items-center justify-center">
                                            <span>âš ï¸</span>
                                    </div>
                                </div>
                                </div>
                                <div className="rounded-xl p-4 bg-gradient-to-br from-amber-50 to-white border border-amber-100">
                                    <div className="flex items-center justify-between">
                                <div>
                                            <div className="text-xs uppercase tracking-wide text-amber-600">High Priority</div>
                                            <div className="text-3xl font-extrabold text-amber-800">{analytics.highPriorityEmails || 0}</div>
                                            </div>
                                        <div className="w-10 h-10 rounded-full bg-amber-100 flex items-center justify-center">
                                            <span>â­</span>
                                        </div>
                                    </div>
                                    </div>
                                </div>
                                
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                {/* Donut chart - By Category */}
                                <div className="rounded-xl border border-gray-100 p-6 bg-gradient-to-br from-gray-50 to-white">
                                    <h4 className="font-semibold mb-6 text-lg text-gray-800 flex items-center">
                                        <svg className="w-5 h-5 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                        </svg>
                                        By Category
                                    </h4>
                                    <div className="flex flex-col lg:flex-row items-center gap-6">
                                        <div className="relative w-32 h-32 flex-shrink-0">
                                            <div
                                                className="w-32 h-32 rounded-full shadow-lg"
                                                style={{ background: `conic-gradient(${donutStops})` }}
                                            />
                                            <div className="absolute inset-4 bg-white rounded-full flex items-center justify-center shadow-inner">
                                                <div className="text-center">
                                                    <div className="text-xs text-gray-500 font-medium">Total</div>
                                                    <div className="text-lg font-bold text-gray-800">{totalByCategory}</div>
                                            </div>
                                    </div>
                                </div>
                                        <div className="flex-1 w-full max-h-80 overflow-y-auto pr-2">
                                            <div className="space-y-3">
                                                {(analytics.byCategory || []).map((c, idx) => {
                                                    const pct = Math.round((c.doc_count / totalByCategory) * 100);
                                                    return (
                                                        <div key={c.key} className="group">
                                                            <div className="flex items-center justify-between mb-1">
                                                                <div className="flex items-center gap-2">
                                                                    <span className="w-3 h-3 rounded-full shadow-sm" style={{ backgroundColor: categoryColors[idx % categoryColors.length] }} />
                                                                    <span className="text-sm font-medium text-gray-700 group-hover:text-gray-900 transition-colors">{c.key}</span>
                                                                </div>
                                                                <div className="flex items-center gap-2">
                                                                    <span className="text-xs text-gray-500">{c.doc_count}</span>
                                                                    <span className="text-sm font-semibold text-gray-900 bg-gray-100 px-2 py-1 rounded-full">{pct}%</span>
                                                                </div>
                                                            </div>
                                                            <div className="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
                                                                <div 
                                                                    className="h-2 rounded-full transition-all duration-300 group-hover:shadow-sm" 
                                                                    style={{ 
                                                                        width: `${pct}%`, 
                                                                        backgroundColor: categoryColors[idx % categoryColors.length],
                                                                        boxShadow: `0 0 8px ${categoryColors[idx % categoryColors.length]}40`
                                                                    }} 
                                                                />
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Horizontal bars - By Priority */}
                                <div className="rounded-xl border border-gray-100 p-6 bg-gradient-to-br from-gray-50 to-white">
                                    <h4 className="font-semibold mb-6 text-lg text-gray-800 flex items-center">
                                        <svg className="w-5 h-5 mr-2 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
                                        </svg>
                                        By Priority
                                    </h4>
                                    <div className="space-y-4">
                                        {(analytics.byPriority || []).map((p) => {
                                            const pct = Math.round((p.doc_count / totalByPriority) * 100);
                                            const color = p.key === 'urgent' ? '#DC2626' : p.key === 'high' ? '#EF4444' : p.key === 'medium' ? '#F59E0B' : '#10B981';
                                            const bgColor = p.key === 'urgent' ? 'bg-red-50' : p.key === 'high' ? 'bg-red-50' : p.key === 'medium' ? 'bg-yellow-50' : 'bg-green-50';
                                            return (
                                                <div key={p.key} className={`p-3 rounded-lg ${bgColor} group`}>
                                                    <div className="flex justify-between items-center mb-2">
                                                        <span className="capitalize text-sm font-semibold text-gray-700 group-hover:text-gray-900 transition-colors">{p.key}</span>
                                                        <div className="flex items-center gap-2">
                                                            <span className="text-xs text-gray-500">{p.doc_count}</span>
                                                            <span className="text-sm font-bold text-gray-900 bg-white px-2 py-1 rounded-full shadow-sm">{pct}%</span>
                                                        </div>
                                                    </div>
                                                    <div className="w-full h-3 bg-gray-200 rounded-full overflow-hidden">
                                                        <div 
                                                            className="h-3 rounded-full transition-all duration-500 group-hover:shadow-lg" 
                                                            style={{ 
                                                                width: `${pct}%`, 
                                                                backgroundColor: color,
                                                                boxShadow: `0 0 12px ${color}60`
                                                            }} 
                                                        />
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>

                                {/* Horizontal bars - By Sentiment */}
                                <div className="rounded-xl border border-gray-100 p-6 bg-gradient-to-br from-gray-50 to-white">
                                    <h4 className="font-semibold mb-6 text-lg text-gray-800 flex items-center">
                                        <svg className="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                        By Sentiment
                                    </h4>
                                    <div className="space-y-4">
                                        {(analytics.bySentiment || []).map((s) => {
                                            const pct = Math.round((s.doc_count / totalBySentiment) * 100);
                                            const color = s.key === 'positive' ? '#10B981' : s.key === 'negative' ? '#EF4444' : '#6366F1';
                                            const bgColor = s.key === 'positive' ? 'bg-green-50' : s.key === 'negative' ? 'bg-red-50' : 'bg-blue-50';
                                            return (
                                                <div key={s.key} className={`p-3 rounded-lg ${bgColor} group`}>
                                                    <div className="flex justify-between items-center mb-2">
                                                        <span className="capitalize text-sm font-semibold text-gray-700 group-hover:text-gray-900 transition-colors">{s.key}</span>
                                                        <div className="flex items-center gap-2">
                                                            <span className="text-xs text-gray-500">{s.doc_count}</span>
                                                            <span className="text-sm font-bold text-gray-900 bg-white px-2 py-1 rounded-full shadow-sm">{pct}%</span>
                                                        </div>
                                                    </div>
                                                    <div className="w-full h-3 bg-gray-200 rounded-full overflow-hidden">
                                                        <div 
                                                            className="h-3 rounded-full transition-all duration-500 group-hover:shadow-lg" 
                                                            style={{ 
                                                                width: `${pct}%`, 
                                                                backgroundColor: color,
                                                                boxShadow: `0 0 12px ${color}60`
                                                            }} 
                                                        />
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            // Require auth
            if (!authToken) {
                return <AuthScreen onSignedIn={handleSignedIn} />;
            }

            return (
                <div className="min-h-screen">
                    {/* Theme Toggle Button */}
                    <button 
                        className="theme-toggle"
                        onClick={() => {
                            document.body.classList.toggle('light-mode');
                            const isLightMode = document.body.classList.contains('light-mode');
                            localStorage.setItem('theme', isLightMode ? 'light' : 'dark');
                        }}
                        title="Toggle theme"
                    >
                        <span id="theme-icon">ðŸŒ™</span>
                    </button>

                    {/* Header */}
                    <header className="bg-blue-600 text-white shadow-lg">
                        <div className="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center py-4">
                                <div>
                                    <h1 className="text-2xl font-bold">ReachInbox Onebox</h1>
                                    <p className="text-sm opacity-90">AI-powered email management</p>
                                </div>
                                <div className="flex items-center space-x-4 -mr-4">
                                    {/* Add Gmail button - slightly moved left */}
                                    <button
                                        onClick={() => setShowGmailSetup(true)}
                                        className="bg-white bg-opacity-20 text-black px-4 py-2 rounded-md hover:bg-opacity-30 transition-all duration-200 flex items-center gap-2 font-medium"
                                    >
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                                        </svg>
                                        Add Gmail
                                    </button>
                                    
                                    {/* Status and Stats Container - slightly moved left */}
                                    <div className="flex items-center space-x-4">
                                        {/* Connection Status */}
                                        <div className="connection-status">
                                        <div className={`w-3 h-3 rounded-full ${wsConnected ? 'bg-green-400' : 'bg-red-400'}`}></div>
                                            <span className="text-sm font-medium">{wsConnected ? 'Live' : 'Offline'}</span>
                                    </div>
                                        {/* User & Logout */}
                                        <div className="hidden sm:flex items-center space-x-3">
                                            {authUser && (<span className="text-sm text-white/90">{authUser.email}</span>)}
                                            <button onClick={handleSignOut} className="text-sm px-3 py-1.5 rounded-md bg-white/20 hover:bg-white/30">Sign out</button>
                                        </div>
                                        
                                        {/* Email Stats */}
                                    {stats && (
                                            <div className="header-stats-container">
                                                <div className="text-xs opacity-80 uppercase tracking-wide font-medium">Total</div>
                                                <div className="text-xl font-bold">{stats.totalEmails}</div>
                                        </div>
                                    )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </header>

                    <div className="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8 py-8 main-content">
                        {/* Search Controls */}
                        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-4">
                                <div className="relative">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Search Query</label>
                                    <input
                                        type="text"
                                        value={searchQuery}
                                        onChange={handleSearchInputChange}
                                        onKeyPress={(e) => {
                                            if (e.key === 'Enter') {
                                                searchEmails();
                                                setShowSuggestions(false);
                                            }
                                        }}
                                        onFocus={() => {
                                            if (searchSuggestions.length > 0) {
                                                setShowSuggestions(true);
                                            }
                                        }}
                                        onBlur={() => {
                                            setTimeout(() => setShowSuggestions(false), 200);
                                        }}
                                        placeholder="Search emails... (Press Enter to search)"
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200"
                                    />
                                    
                                    {/* Search Suggestions Dropdown */}
                                    {showSuggestions && searchSuggestions.length > 0 && (
                                        <div className="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-40 overflow-y-auto">
                                            {searchSuggestions.map((suggestion, index) => (
                                                <div
                                                    key={index}
                                                    onClick={() => {
                                                        setSearchQuery(suggestion);
                                                        setShowSuggestions(false);
                                                        searchEmails();
                                                    }}
                                                    className="px-3 py-2 hover:bg-blue-50 cursor-pointer text-sm text-gray-700 border-b border-gray-100 last:border-b-0"
                                                >
                                                    {suggestion}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Account</label>
                                    <div className="flex space-x-2">
                                        <select
                                            value={selectedAccount}
                                            onChange={(e) => {
                                                console.log(`ðŸ”„ Account selection changed to: ${e.target.value}`);
                                                setSelectedAccount(e.target.value);
                                            }}
                                            className="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        >
                                            <option value="">All Accounts</option>
                                            {accounts.map(account => (
                                                <option key={account.id} value={account.id}>
                                                    {account.type === 'gmail' ? `ðŸ“§ ${account.name || account.email}` : account.email}
                                                </option>
                                            ))}
                                        </select>
                                        {selectedAccount && (
                                            <button
                                                onClick={() => removeGmailAccount(selectedAccount)}
                                                className="px-2 py-2 bg-red-600 text-white text-xs rounded hover:bg-red-700 transition-colors"
                                                title="Delete selected account"
                                            >
                                                ðŸ—‘ï¸
                                            </button>
                                        )}
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Category</label>
                                    <select
                                        value={selectedCategory}
                                        onChange={(e) => setSelectedCategory(e.target.value)}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    >
                                        <option value="">All Categories</option>
                                        <option value="Interested">Interested</option>
                                        <option value="Meeting">Meeting</option>
                                        <option value="Urgent">Urgent</option>
                                        <option value="Complaint">Complaint</option>
                                        <option value="Newsletter">Newsletter</option>
                                        <option value="Billing">Billing</option>
                                        <option value="Job">Job</option>
                                        <option value="Security">Security</option>
                                        <option value="Social">Social</option>
                                        <option value="Support">Support</option>
                                        <option value="Notification">Notification</option>
                                        <option value="Invitation">Invitation</option>
                                        <option value="Document">Document</option>
                                        <option value="Feedback">Feedback</option>
                                        <option value="Travel">Travel</option>
                                        <option value="Health">Health</option>
                                        <option value="Education">Education</option>
                                        <option value="Shopping">Shopping</option>
                                        <option value="Finance">Finance</option>
                                        <option value="Entertainment">Entertainment</option>
                                        <option value="Automated">Automated</option>
                                        <option value="Tech">Tech</option>
                                        <option value="General">General</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Priority</label>
                                    <select
                                        value={selectedPriority}
                                        onChange={(e) => setSelectedPriority(e.target.value)}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    >
                                        <option value="">All Priorities</option>
                                        <option value="urgent">Urgent</option>
                                        <option value="high">High</option>
                                        <option value="medium">Medium</option>
                                        <option value="low">Low</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Date Range</label>
                                    <div className="grid grid-cols-2 gap-2">
                                        <div>
                                            <label className="block text-xs text-gray-600 mb-1">From</label>
                                            <input
                                                type="date"
                                                value={dateFrom}
                                                onChange={(e) => setDateFrom(e.target.value)}
                                                className="w-full px-2 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-xs text-gray-600 mb-1">To</label>
                                            <input
                                                type="date"
                                                value={dateTo}
                                                onChange={(e) => setDateTo(e.target.value)}
                                                className="w-full px-2 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                            />
                                        </div>
                                    </div>
                                    {(dateFrom || dateTo) && (
                                        <button
                                            onClick={() => {
                                                setDateFrom('');
                                                setDateTo('');
                                            }}
                                            className="w-full mt-2 px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded hover:bg-gray-200 transition-colors"
                                        >
                                            Clear
                                        </button>
                                    )}
                                </div>
                            </div>
                            
                            <div className="flex justify-between items-center">
                                <div className="flex space-x-2">
                                    <button
                                        onClick={searchEmails}
                                        disabled={loading || accounts.length === 0 || !selectedAccount}
                                        className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 flex items-center gap-2"
                                    >
                                        {loading ? (
                                            <>
                                                <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                                                Searching...
                                            </>
                                        ) : (
                                            <>
                                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                                </svg>
                                                Search
                                            </>
                                        )}
                                    </button>
                                    
                                    <button
                                        onClick={() => setShowComposer(true)}
                                        className="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 flex items-center gap-2"
                                    >
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                                        </svg>
                                        Compose
                                    </button>
                                    
                                    <button
                                        onClick={() => setShowAnalytics(true)}
                                        className="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 flex items-center gap-2"
                                    >
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                        </svg>
                                        Analytics
                                    </button>
                                </div>
                                
                                <div className="flex space-x-2">
                                    <button
                                        onClick={() => showExportConfirmation('csv')}
                                        disabled={accounts.length === 0}
                                        className="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 flex items-center gap-2"
                                    >
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                        </svg>
                                        Export CSV
                                    </button>
                                    
                                    <button
                                        onClick={testIntegrations}
                                        className="px-4 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700 flex items-center gap-2"
                                    >
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                                        </svg>
                                        Test
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* Email List */}
                        <div className="bg-white rounded-lg shadow-lg">
                            <div className="p-6 border-b border-gray-200">
                                <h2 className="text-xl font-semibold text-gray-900">Emails</h2>
                                <p className="text-sm text-gray-600 mt-1">
                                    {emails.length > 0 ? `Showing ${emails.length} emails` : 'No emails found'}
                                </p>
                            </div>
                            
                        {/* Email Detail Modal */}
                        {emailModalOpen && selectedEmail && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 z-50">
                                <div className="absolute left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-4xl mx-4" style={{ top: `${modalTop}px` }}>
                                    <div className="bg-white rounded-2xl shadow-2xl w-full max-h-[88vh] overflow-hidden">
                                    {/* Header */}
                                    <div className="px-6 py-4 border-b border-gray-200 flex items-start justify-between">
                                        <div className="flex items-start gap-4">
                                            <div className="w-10 h-10 rounded-full bg-purple-600 text-white flex items-center justify-center font-semibold">
                                                {getInitials(selectedEmail._source?.from || selectedEmail.from)}
                                            </div>
                                            <div>
                                                <h2 className="text-lg font-semibold text-gray-900">
                                                    {selectedEmail._source?.subject || selectedEmail.subject}
                                                </h2>
                                                <div className="text-sm text-gray-600 mt-1">
                                                    <div className="flex flex-wrap items-center gap-2">
                                                        <span className="font-medium text-gray-800">{getDisplayName(selectedEmail._source?.from || selectedEmail.from)}</span>
                                                        <span className="text-gray-500">&lt;{(selectedEmail._source?.from || selectedEmail.from)}&gt;</span>
                                                        <span className="mx-2 text-gray-300">â€¢</span>
                                                        <span>{formatDate(selectedEmail._source?.date || selectedEmail.date)}</span>
                                                    </div>
                                                    <div className="flex flex-wrap items-center gap-2 mt-1">
                                                        <span className="text-gray-500">To:</span>
                                                        <span className="text-gray-800">{(selectedEmail._source?.to || selectedEmail.to || []).join ? (selectedEmail._source?.to || selectedEmail.to || []).join(', ') : (selectedEmail._source?.to || selectedEmail.to || '')}</span>
                                                    </div>
                                                    <div className="flex items-center gap-2 mt-2">
                                                        <span className={`category-badge ${getCategoryClass(selectedEmail._source?.aiCategory || selectedEmail.category)}`}>
                                                            {selectedEmail._source?.aiCategory || selectedEmail.category}
                                                        </span>
                                                        <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                            Priority: {selectedEmail._source?.priority || selectedEmail.priority}
                                                        </span>
                                                        <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                            Score: {selectedEmail._source?.leadScore || selectedEmail.leadScore}
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <button onClick={closeEmailModal} className="text-gray-400 hover:text-gray-600 text-xl">âœ•</button>
                                    </div>

                                    {/* Body */}
                                    <div className="px-6 py-5 overflow-y-auto max-h-[70vh]">
                                        <div className="mb-6">
                                            {renderEmailBody(selectedEmail._source?.body || selectedEmail.body)}
                                        </div>

                                        {/* Media previews */}
                                        {(() => { const { images, pdfs } = extractMediaLinks(selectedEmail._source?.body || selectedEmail.body); if (images.length===0 && pdfs.length===0) return null; return (
                                            <div className="space-y-4">
                                                {images.length > 0 && (
                                                    <div>
                                                        <div className="text-sm font-medium text-gray-700 mb-2">Images</div>
                                                        <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                                                            {images.slice(0,6).map((src, idx) => (
                                                                <a key={idx} href={src} target="_blank" rel="noopener noreferrer" className="block">
                                                                    <img src={src} alt="inline" className="w-full h-32 object-cover rounded-lg border" />
                                                                </a>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}
                                                {pdfs.length > 0 && (
                                                    <div>
                                                        <div className="text-sm font-medium text-gray-700 mb-2">Documents</div>
                                                        <div className="space-y-2">
                                                            {pdfs.slice(0,4).map((u, idx) => (
                                                                <a key={idx} href={u} target="_blank" rel="noopener noreferrer" className="inline-flex items-center gap-2 text-blue-600 underline">
                                                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 11V3m0 8l-3-3m3 3l3-3M5 13v6a2 2 0 002 2h10a2 2 0 002-2v-6"/></svg>
                                                                    Open PDF
                                                                </a>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        ); })()}
                                    </div>
                                    </div>
                                </div>
                            </div>
                        )}
                            <div className="email-list-container">
                                {emails.length === 0 ? (
                                    <div className="p-8 text-center">
                                        <svg className="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                                        </svg>
                                        <h3 className="mt-2 text-sm font-medium text-gray-900">No emails</h3>
                                        <p className="mt-1 text-sm text-gray-500">Get started by searching for emails or adding a Gmail account.</p>
                                    </div>
                                ) : (
                                    <div className="divide-y divide-gray-200">
                                        {emails.map((email) => (
                                            <div key={email.id} className={`email-card p-6 hover:bg-gray-50 cursor-pointer ${getPriorityClass(email._source?.priority || email.priority)}`} onClick={(e) => openEmailModal(email, e)}>
                                                <div className="flex items-start justify-between">
                                                    <div className="flex-1 min-w-0">
                                                        <div className="flex items-center space-x-3 mb-2">
                                                            <h3 className="text-lg font-medium text-gray-900 truncate">
                                                                {email._source?.subject || email.subject}
                                                            </h3>
                                                            <span className={`category-badge ${getCategoryClass(email._source?.aiCategory || email.category)}`}>
                                                                {email._source?.aiCategory || email.category}
                                                            </span>
                                                        </div>
                                                        
                                                        <div className="flex items-center space-x-4 text-sm text-gray-500 mb-3">
                                                            <span className="flex items-center">
                                                                <svg className="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207" />
                                                                </svg>
                                                                {email._source?.from || email.from}
                                                            </span>
                                                            <span className="flex items-center">
                                                                <svg className="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                                </svg>
                                                                {formatDate(email._source?.date || email.date)}
                                                            </span>
                                                            <span className={`font-medium ${getSentimentClass(email._source?.sentiment || email.sentiment)}`}>
                                                                {email._source?.sentiment || email.sentiment}
                                                            </span>
                                                        </div>
                                                        
                                                        <p className="text-gray-600 text-sm mb-4 line-clamp-3">
                                                            {cleanEmailForDisplay(email._source?.body || email.body)}
                                                        </p>
                                                        
                                                        <div className="flex items-center space-x-2">
                                                            <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                                Priority: {email._source?.priority || email.priority}
                                                            </span>
                                                            <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                                Score: {email._source?.leadScore || email.leadScore}
                                                            </span>
                                                        </div>
                                                    </div>
                                                    
                                                    <div className="flex items-center space-x-2 ml-4">
                                                        <button
                                                            onClick={() => openReplyModal(email)}
                                                            className="px-3 py-1 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700 flex items-center gap-1"
                                                        >
                                                            {replyLoading ? (
                                                                <div className="animate-spin rounded-full h-3 w-3 border-b-2 border-white"></div>
                                                            ) : (
                                                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                                                                </svg>
                                                            )}
                                                            Reply
                                                        </button>
                                                    </div>
                                                </div>
                                                
                                                {suggestedReply && (
                                                    <div className="mt-4 p-4 bg-blue-50 rounded-md">
                                                        <h4 className="text-sm font-medium text-blue-900 mb-2">Suggested Reply:</h4>
                                                        <p className="text-sm text-blue-800">{suggestedReply}</p>
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Gmail Setup Modal */}
                    {showGmailSetup && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 pt-8 pb-8">
                            <div className="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 shadow-2xl transform transition-all duration-300 ease-in-out animate-modalSlideIn">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-semibold">Add Gmail Account</h3>
                                    <button
                                        onClick={() => setShowGmailSetup(false)}
                                        className="text-gray-400 hover:text-gray-600"
                                    >
                                        âœ•
                                    </button>
                                </div>
                                
                                <div className="space-y-4">
                                     <div className="bg-blue-50 border border-blue-200 rounded-md p-4 mb-4">
                                         <h4 className="text-sm font-medium text-blue-800 mb-2">ðŸ“‹ Setup Instructions:</h4>
                                         <ol className="text-xs text-blue-700 space-y-1">
                                             <li>1. Enable 2-Factor Authentication on your Gmail account</li>
                                             <li>2. Generate an App Password (not your regular password)</li>
                                             <li>3. Use your Gmail address and the 16-character app password</li>
                                             <li>4. We'll validate your credentials before adding the account</li>
                                         </ol>
                                     </div>
                                     
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Account Name</label>
                                        <input
                                            type="text"
                                            value={newGmailAccount.name}
                                            onChange={(e) => setNewGmailAccount({...newGmailAccount, name: e.target.value})}
                                            placeholder="My Gmail Account"
                                             disabled={addingAccount}
                                             className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50"
                                        />
                                    </div>
                                    <div>
                                         <label className="block text-sm font-medium text-gray-700 mb-2">Gmail Address</label>
                                        <input
                                            type="email"
                                            value={newGmailAccount.email}
                                            onChange={(e) => setNewGmailAccount({...newGmailAccount, email: e.target.value})}
                                            placeholder="your-email@gmail.com"
                                             disabled={addingAccount}
                                             className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50"
                                        />
                                         <p className="text-xs text-gray-500 mt-1">
                                             Must be a Gmail address (@gmail.com)
                                         </p>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">App Password</label>
                                        <input
                                            type="password"
                                            value={newGmailAccount.appPassword}
                                            onChange={(e) => setNewGmailAccount({...newGmailAccount, appPassword: e.target.value})}
                                             placeholder="16-character app password (no spaces)"
                                             disabled={addingAccount}
                                             className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50"
                                        />
                                        <p className="text-xs text-gray-500 mt-1">
                                             Generate an app password in your Google Account settings â†’ Security â†’ App passwords
                                        </p>
                                    </div>
                                </div>
                                
                                <div className="flex justify-end space-x-2 mt-6">
                                    <button
                                        onClick={() => setShowGmailSetup(false)}
                                         disabled={addingAccount}
                                         className="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={addGmailAccount}
                                         disabled={addingAccount}
                                         className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 flex items-center gap-2"
                                     >
                                         {addingAccount ? (
                                             <>
                                                 <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                                                 Validating...
                                             </>
                                         ) : (
                                             'Add Account'
                                         )}
                                    </button>
                                </div>
                                
                                {/* Gmail Accounts List */}
                                {gmailAccounts.length > 0 && (
                                    <div className="mt-6">
                                        <h4 className="text-sm font-medium text-gray-700 mb-3">Existing Gmail Accounts</h4>
                                        <div className="space-y-2">
                                            {gmailAccounts.map(account => (
                                                <div key={account.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-md">
                                                    <div>
                                                        <div className="font-medium text-sm">{account.name || account.email}</div>
                                                        <div className="text-xs text-gray-500">{account.email}</div>
                                                    </div>
                                                    <div className="flex space-x-2">
                                                        <button
                                                            onClick={() => testGmailConnection(account.id)}
                                                            className="px-2 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700"
                                                        >
                                                            Test
                                                        </button>
                                                        <button
                                                            onClick={() => removeGmailAccount(account.id)}
                                                            className="px-2 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700"
                                                        >
                                                            Remove
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Email Composer Modal */}
                    {showComposer && <EmailComposer />}

                    {/* Reply Modal */}
                    {replyModalOpen && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 pt-8 pb-8">
                            <div className="bg-white rounded-lg p-6 w-full max-w-2xl mx-4 shadow-2xl transform transition-all duration-300 ease-in-out animate-modalSlideIn">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-semibold">Send Reply</h3>
                                    <button
                                        onClick={closeReplyModal}
                                        className="text-gray-500 hover:text-gray-700"
                                    >
                                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                                
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">To</label>
                                        <input
                                            type="email"
                                            value={replyData.to}
                                            onChange={(e) => setReplyData(prev => ({ ...prev, to: e.target.value }))}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            placeholder="Recipient email"
                                        />
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Subject</label>
                                        <input
                                            type="text"
                                            value={replyData.subject}
                                            onChange={(e) => setReplyData(prev => ({ ...prev, subject: e.target.value }))}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            placeholder="Email subject"
                                        />
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Message</label>
                                        <textarea
                                            value={replyData.body}
                                            onChange={(e) => setReplyData(prev => ({ ...prev, body: e.target.value }))}
                                            rows={6}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            placeholder="Type your reply message here..."
                                        />
                                    </div>
                                </div>
                                
                                <div className="flex justify-end space-x-3 mt-6">
                                    <button
                                        onClick={closeReplyModal}
                                        className="px-4 py-2 text-gray-600 bg-gray-100 rounded-md hover:bg-gray-200"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={handleSendReply}
                                        disabled={sendingReply || !replyData.body.trim()}
                                        className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                                    >
                                        {sendingReply ? (
                                            <>
                                                <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                                                Sending...
                                            </>
                                        ) : (
                                            'Send Reply'
                                        )}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Export Confirmation Modal */}
                    {exportModalOpen && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 pt-8 pb-8">
                            <div className="bg-white rounded-lg p-6 w-full max-w-md mx-4 shadow-2xl transform transition-all duration-300 ease-in-out animate-modalSlideIn">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-semibold">Export Emails</h3>
                                    <button
                                        onClick={() => setExportModalOpen(false)}
                                        className="text-gray-500 hover:text-gray-700"
                                    >
                                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                                
                                <div className="space-y-4">
                                    <p className="text-gray-600">What would you like to export?</p>
                                    
                                    <div className="space-y-3">
                                        <button
                                            onClick={() => handleExportConfirm(false)}
                                            className="w-full p-4 border-2 border-blue-200 rounded-lg hover:border-blue-400 hover:bg-blue-50 transition-all duration-200 text-left"
                                        >
                                            <div className="flex items-center space-x-3">
                                                <div className="w-4 h-4 border-2 border-blue-500 rounded-full flex items-center justify-center">
                                                    <div className="w-2 h-2 bg-blue-500 rounded-full"></div>
                                                </div>
                                                <div>
                                                    <div className="font-medium text-gray-900">Selected Account Only</div>
                                                    <div className="text-sm text-gray-500">
                                                        {selectedAccount ? 
                                                            `Export emails from ${accounts.find(acc => acc.id === selectedAccount)?.email || 'selected account'} only` : 
                                                            'Please select an account first'
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                        </button>
                                        
                                        <button
                                            onClick={() => handleExportConfirm(true)}
                                            className="w-full p-4 border-2 border-gray-200 rounded-lg hover:border-gray-400 hover:bg-gray-50 transition-all duration-200 text-left"
                                        >
                                            <div className="flex items-center space-x-3">
                                                <div className="w-4 h-4 border-2 border-gray-400 rounded-full"></div>
                                                <div>
                                                    <div className="font-medium text-gray-900">All Emails</div>
                                                    <div className="text-sm text-gray-500">Export all emails from all Gmail accounts (ignores current filters)</div>
                                                </div>
                                            </div>
                                        </button>
                                    </div>
                                </div>
                                
                                <div className="flex justify-end space-x-3 mt-6">
                                    <button
                                        onClick={() => setExportModalOpen(false)}
                                        className="px-4 py-2 text-gray-600 bg-gray-100 rounded-md hover:bg-gray-200"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Analytics Modal */}
                    {showAnalytics && <AnalyticsDashboard />}

                    {/* Enhanced Toast Notifications */}
                    <div className="fixed bottom-4 left-4 z-50 space-y-2 max-w-sm sm:max-w-md notification-container">
                        {notifications.map(notification => (
                            <div
                                key={notification.id}
                                className={`p-4 rounded-lg shadow-xl max-w-sm transform transition-all duration-300 ease-in-out animate-slideIn ${
                                    notification.type === 'success' ? 'bg-gradient-to-r from-green-500 to-green-600 text-white border border-green-400' :
                                    notification.type === 'error' ? 'bg-gradient-to-r from-red-500 to-red-600 text-white border border-red-400' :
                                    notification.type === 'info' ? 'bg-gradient-to-r from-blue-500 to-blue-600 text-white border border-blue-400' :
                                    'bg-gradient-to-r from-gray-500 to-gray-600 text-white border border-gray-400'
                                }`}
                                style={{
                                    animation: 'slideIn 0.3s ease-out'
                                }}
                            >
                                <div className="flex items-center">
                                    <div className="flex-1">
                                        <div className="flex items-center gap-2">
                                            {notification.type === 'success' && (
                                                <svg className="w-5 h-5 text-green-100" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                            )}
                                            {notification.type === 'error' && (
                                                <svg className="w-5 h-5 text-red-100" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                            )}
                                            {notification.type === 'info' && (
                                                <svg className="w-5 h-5 text-blue-100" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                            )}
                                            <p className="text-sm font-semibold">{notification.message}</p>
                                        </div>
                                        <p className="text-xs opacity-80 mt-1">
                                            {new Date(notification.timestamp).toLocaleTimeString()}
                                        </p>
                                    </div>
                                    <button
                                        onClick={() => setNotifications(prev => prev.filter(n => n.id !== notification.id))}
                                        className="ml-3 text-white hover:text-gray-200 transition-colors duration-200 p-1 rounded-full hover:bg-white hover:bg-opacity-20"
                                    >
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));

        // Theme initialization
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme');
            const themeIcon = document.getElementById('theme-icon');
            
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
                themeIcon.textContent = 'â˜€ï¸';
            } else {
                themeIcon.textContent = 'ðŸŒ™';
            }
        });

        // Update theme icon when toggled
        document.addEventListener('click', function(e) {
            if (e.target.closest('.theme-toggle')) {
                const themeIcon = document.getElementById('theme-icon');
                const isLightMode = document.body.classList.contains('light-mode');
                themeIcon.textContent = isLightMode ? 'â˜€ï¸' : 'ðŸŒ™';
            }
        });
    </script>
</body>
</html>